name: C# Lint and Build

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**/*.cs'
      - 'src/**/*.csproj'
      - '.github/workflows/csharp-lint.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**/*.cs'
      - 'src/**/*.csproj'
      - '.github/workflows/csharp-lint.yml'

# Security: Explicit permissions following principle of least privilege
permissions:
  contents: read

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true

jobs:
  lint-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      timeout-minutes: 5
      run: |
        cd src
        echo "üì¶ Restoring dependencies (max 5 minutes)..."
        timeout 300s dotnet restore --verbosity minimal

    - name: Apply code formatting
      continue-on-error: true
      timeout-minutes: 3
      run: |
        cd src
        echo "üîç Applying code formatting (max 3 minutes)..."
        timeout 180s dotnet format --verbosity minimal
        echo "‚úÖ Code formatting applied"

    - name: Build solution
      timeout-minutes: 10
      run: |
        cd src
        echo "üî® Building solution (max 10 minutes)..."
        timeout 600s dotnet build --configuration Release --no-restore --verbosity minimal

    - name: Run static analysis
      continue-on-error: true
      timeout-minutes: 8
      run: |
        cd src
        echo "üîç Running static analysis (max 8 minutes)..."
        timeout 480s dotnet build --configuration Release --verbosity normal --property:TreatWarningsAsErrors=false --property:WarningsAsErrors="" --property:WarningsNotAsErrors=""

    - name: Check for security vulnerabilities
      timeout-minutes: 3
      run: |
        cd src
        echo "üõ°Ô∏è Checking for security vulnerabilities (max 3 minutes)..."
        timeout 180s dotnet list package --vulnerable --include-transitive || echo "No vulnerabilities found or command not supported"

    - name: Check for deprecated packages
      timeout-minutes: 2
      run: |
        cd src
        echo "üì¶ Checking for deprecated packages (max 2 minutes)..."
        timeout 120s dotnet list package --deprecated || echo "No deprecated packages found or command not supported"

    - name: Analyze code metrics
      run: |
        cd src
        echo "üìä Analyzing code metrics..."

        # Count lines of code
        echo "Lines of C# code:"
        find . -name "*.cs" -not -path "./bin/*" -not -path "./obj/*" | xargs wc -l | tail -1

        # Count files
        echo "C# files:"
        find . -name "*.cs" -not -path "./bin/*" -not -path "./obj/*" | wc -l

        # Check for TODO/FIXME comments
        echo "TODO/FIXME comments:"
        grep -r "TODO\|FIXME\|HACK" --include="*.cs" . || echo "None found"

    - name: Test build artifacts
      run: |
        cd src
        echo "üß™ Testing build artifacts..."

        # Check if main executable was built
        if [ -f "bin/Release/net8.0/overlay-companion-mcp" ] || [ -f "bin/Release/net8.0/overlay-companion-mcp.exe" ]; then
          echo "‚úÖ Main executable found"
        else
          echo "‚ùå Main executable not found"
          ls -la bin/Release/net8.0/ || echo "Build output directory not found"
        fi

        # Check assembly info
        dotnet --info

    - name: Upload build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ github.sha }}
        path: |
          src/bin/Release/
          !src/bin/Release/**/*.pdb
        retention-days: 7

    - name: Summary
      if: always()
      run: |
        echo "=================================="
        echo "üèÅ C# Lint and Build Summary"
        echo "=================================="
        echo "‚úÖ Code formatting check completed"
        echo "‚úÖ Build completed"
        echo "‚úÖ Static analysis completed"
        echo "‚úÖ Security check completed"
        echo "‚úÖ Code metrics analyzed"

        if [ "${{ job.status }}" == "success" ]; then
          echo "üéâ All checks passed!"
        else
          echo "‚ùå Some checks failed. Please review the logs above."
        fi
