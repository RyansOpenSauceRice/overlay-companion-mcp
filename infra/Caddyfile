:80 {
  encode gzip

  # Custom Overlay Web Interface (main interface with MCP-powered icons)
  @overlay path_regexp overlay ^/($|index\.html|app|overlay|static|assets)
  handle @overlay {
    reverse_proxy overlay-web:8080
  }

  # MCP Server API endpoints
  @mcp_api path_regexp mcp_api ^/(api|mcp|health)
  handle @mcp_api {
    reverse_proxy mcp-server:3000
  }

  # MCP WebSocket connections
  handle_path /ws/* {
    reverse_proxy mcp-server:3000
  }

  # Guacamole web app (Tomcat); rewrite /guac/* -> /guacamole/*
  handle_path /guac/* {
    rewrite * /guacamole{path}
    reverse_proxy guacamole:8080
  }

  # Direct Guacamole access (for debugging)
  handle_path /guacamole/* {
    reverse_proxy guacamole:8080
  }

  # Default: route to custom overlay web interface
  handle {
    reverse_proxy overlay-web:8080
  }
}
