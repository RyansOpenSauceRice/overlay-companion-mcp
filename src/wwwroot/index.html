<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Overlay Companion Viewer (Stub)</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; overflow: hidden; background: #111;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #eee;
    }
    #toolbar { position: fixed; top: 8px; left: 8px; right: 8px; z-index: 1000; display: flex; gap: 8px; align-items: center; }
    #status { margin-left: auto; font-size: 12px; opacity: 0.8; }
    #viewer { position: absolute; inset: 0; background: #222; }
    #display-layer, #overlay-layer { position: absolute; inset: 0; pointer-events: none; }
    #overlay-layer { z-index: 999; }
    .overlay-box { position: absolute; border: 2px dashed #f33; box-sizing: border-box; opacity: 0.6; }
    .label { position: absolute; top: -20px; left: 0; font-size: 12px; background: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 3px; pointer-events: none; }
  </style>
</head>
<body>
  <div id="toolbar">
    <button id="connect">Connect</button>
    <a href="/setup" target="_blank">Setup</a>
    <div id="status">Disconnected</div>
  </div>
  <div id="viewer"></div>
  <div id="display-layer"></div>
  <div id="overlay-layer"></div>
  <div id="guac-container" style="position:absolute; inset:0; z-index:0;"></div>
  <!-- Optional Guacamole iframe as a first step before guacamole-common-js embed -->
  <iframe id="guac-iframe" src="/guac" style="position:absolute; inset:0; border:0; z-index:1;"></iframe>


    <script>
      // If guacamole-common-js is present, initialize it directly instead of iframe
      (function initGuac() {
        if (!window.Guacamole) return; // keep iframe fallback
        const iframe = document.getElementById('guac-iframe');
        if (iframe) iframe.remove();
        const container = document.getElementById('guac-container');
        const display = new Guacamole.Display();
        container.appendChild(display.getElement());
        // Tunnel via HTTP to /guac/ (Caddy proxies to Tomcat Guacamole)
        const tunnel = new Guacamole.HTTPTunnel('/guac/tunnel');
        const client = new Guacamole.Client(tunnel);
        client.onstatechange = function(state) {
          // 0=idle,1=connecting,2=waiting,3=connected,4=disconnecting,5=disconnected
          console.log('Guac state:', state);
        };
        client.onerror = function(e) { console.error('Guac error', e); };
        client.onchat = function(msg) { console.log('Guac chat:', msg); };
        client.onclipboard = function(stream, mimetype) { stream.sendEnd(); };
        client.onname = function(name) { console.log('Guac name:', name); };
        client.onfile = function(stream, mimetype, filename) { stream.sendEnd(); };
        window.addEventListener('resize', function() {
          const w = window.innerWidth, h = window.innerHeight;
          client.sendSize(w, h);
          display.scale(Math.min(w / virtual.width, h / virtual.height));
        });
        // Mouse/keyboard passthrough (optional)
        const mouse = new Guacamole.Mouse(display.getElement());
        const keyboard = new Guacamole.Keyboard(document);
        mouse.onmousedown = mouse.onmouseup = mouse.onmousemove = function(state) {
          client.sendMouseState(state);
        };
        keyboard.onkeydown = function (keysym) { client.sendKeyEvent(1, keysym); };
        keyboard.onkeyup = function (keysym) { client.sendKeyEvent(0, keysym); };
        // Connect â€“ parameters can be provided via querystring or configured server-side
        client.connect();
        window.addEventListener('unload', function() { client.disconnect(); });
      })();
    </script>
    <script src="/guac/js/guacamole-common.min.js" async></script>


  <script>
    const statusEl = document.getElementById('status');
    const overlayLayer = document.getElementById('overlay-layer');
    const displayLayer = document.getElementById('display-layer');
    const guacContainer = document.getElementById('guac-container');
    const connectBtn = document.getElementById('connect');

    let ws;
    let virtual = { min_x: 0, min_y: 0, width: 1920, height: 1080 };
    let scale = 1;

    function setStatus(text, ok) {
      statusEl.textContent = text;
      statusEl.style.color = ok ? '#8f8' : '#f88';
    }

    function layoutLayers() {
      const vw = window.innerWidth; const vh = window.innerHeight;
      const sx = vw / virtual.width; const sy = vh / virtual.height;
      scale = Math.min(sx, sy);
      const tx = -virtual.min_x * scale; const ty = -virtual.min_y * scale;
      const transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
      overlayLayer.style.transformOrigin = '0 0';
      overlayLayer.style.transform = transform;
      displayLayer.style.transformOrigin = '0 0';
      displayLayer.style.transform = transform;
      const iframe = document.getElementById('guac-iframe');
      if (iframe) {
        iframe.style.width = window.innerWidth + 'px';
        iframe.style.height = window.innerHeight + 'px';
      }
    }

    function renderOverlay(o) {
      let el = document.getElementById('ov-' + o.id);
      if (!el) {
        el = document.createElement('div');
        el.className = 'overlay-box';
        el.id = 'ov-' + o.id;
        const label = document.createElement('div');
        label.className = 'label';
        label.id = 'ov-label-' + o.id;
        el.appendChild(label);
        overlayLayer.appendChild(el);
      }
      el.style.left = o.bounds.x + 'px';
      el.style.top = o.bounds.y + 'px';
      el.style.width = o.bounds.width + 'px';
      el.style.height = o.bounds.height + 'px';
      el.style.borderColor = o.color || '#f33';
      el.style.opacity = (o.opacity ?? 0.5).toString();
      const label = document.getElementById('ov-label-' + o.id);
      label.textContent = o.label || '';
    }

    function removeOverlay(id) {
      const el = document.getElementById('ov-' + id);
      if (el) el.remove();
    }

    function resetOverlays() {
      overlayLayer.innerHTML = '';
    }

    function renderDisplays(displays) {
      displayLayer.innerHTML = '';
      if (!displays) return;
      displays.forEach(d => {
        const el = document.createElement('div');
        el.className = 'overlay-box';
        el.style.borderStyle = 'solid';
        el.style.borderColor = '#0af';
        el.style.opacity = '0.2';
        el.style.left = d.x + 'px';
        el.style.top = d.y + 'px';
        el.style.width = d.width + 'px';
        el.style.height = d.height + 'px';
        const label = document.createElement('div');
        label.className = 'label';
        label.textContent = `${d.name || 'Display'} (${d.width}x${d.height})`;
        el.appendChild(label);
        displayLayer.appendChild(el);
      });
    }
      // Resize potential Guacamole container to fill viewport
      guacContainer.style.width = window.innerWidth + 'px';
      guacContainer.style.height = window.innerHeight + 'px';


    function handleMessage(msg) {
      try {
        const data = JSON.parse(msg.data);
        if (data.type === 'sync') {
          virtual = data.virtual_screen || virtual;
          layoutLayers();
          renderDisplays(data.displays);
          resetOverlays();
          (data.overlays || []).forEach(renderOverlay);
        } else if (data.type === 'overlay_created' || data.type === 'overlay_updated') {
          renderOverlay(data.overlay);
        } else if (data.type === 'overlay_removed') {
          removeOverlay(data.overlayId);
        }
      } catch (e) { console.warn('Bad WS message', e); }
    }

    function connect() {
      if (ws && ws.readyState === WebSocket.OPEN) return;
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      ws = new WebSocket(proto + '://' + location.host + '/ws/overlays');
      ws.onopen = () => setStatus('Connected', true);
      ws.onclose = () => setStatus('Disconnected', false);
      ws.onerror = () => setStatus('Error', false);
      ws.onmessage = handleMessage;
    }

    connectBtn.addEventListener('click', connect);
    window.addEventListener('resize', layoutLayers);

  </script>
</body>
</html>